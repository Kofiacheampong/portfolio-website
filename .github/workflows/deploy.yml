name: Deploy Portfolio to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Upload site files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        source: "."
        target: "/home/opc/portfolio_tmp"
        rm: true

    - name: Deploy on server (SELinux-safe)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          set -e

          LIVE_DIR="/var/www/portfolio"
          TMP_DIR="/home/opc/portfolio_tmp"

          echo "üöö Deploying site..."

          sudo mkdir -p $LIVE_DIR

          # Use rsync (NOT cp) to avoid SELinux label issues
          sudo rsync -a --delete $TMP_DIR/ $LIVE_DIR/

          # Correct ownership & permissions for Oracle Linux
          sudo chown -R nginx:nginx $LIVE_DIR
          sudo find $LIVE_DIR -type d -exec chmod 755 {} \;
          sudo find $LIVE_DIR -type f -exec chmod 644 {} \;

          # Restore SELinux context
          sudo restorecon -Rv $LIVE_DIR

          # Cleanup
          rm -rf $TMP_DIR

          echo "üß™ Testing Nginx configuration..."
          sudo nginx -t

          echo "üîÑ Reloading Nginx..."
          sudo systemctl reload nginx

          echo "‚úÖ Deployment completed successfully"

    - name: Verify deployment
      run: |
        echo "Waiting for site to reload..."
        sleep 5

        for i in {1..3}; do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://kofiarcher.com/portfolio)
          echo "Attempt $i ‚Üí HTTP $STATUS"

          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Site is live"
            exit 0
          fi

          sleep 5
        done

        echo "‚ö†Ô∏è Verification did not return 200, check manually"
        exit 0
